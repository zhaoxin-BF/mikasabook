# 欢迎来到北峰科技技术有限责任公司

# 背景及现状痛点
- 1、备机申请不及时(无法及时发现缺备用机器)
- 2、备机查找困难(需花费较长时间去CMDB系统查找，且不一定能保证准确性)


# 一、需求分析
- 1、多条件灵活设置备用机器规则，根据规则展示机器详情。
- 2、备机数量不足监控、自动告警（催机器），告警通知人配置。
- 3、可灵活供多个业务组使用（Udisk/Ark/Ufs/其他）。
- 4、备机匹配查找，列表展示。

## 综合以上四点要求，分析备机系统主要功能如下
- 1、备机设置——各业务备机规则设置功能
- 2、备机展示——各业务备机按其设置规则分表展示功能
- 3、备机查找——备机匹配(查找)功能
- 4、备机监控——备机监控、告警功能

## 说明：
### 1、备机设置——各业务备机规则设置功能
  - 描述：多条件灵活设置备用机器规则，入库持久化。（以udis业务为例，*代表其他）。配置规则如下：
    - 业务组（单选）：udisk/*
    - 机器类型（单选）：物理机/虚拟机
    - 可用区（单选）：北京二可用区B（cn-bj2-02）/*
    - 逻辑机房（单选）：HB11/*
    - 二级业务（可多选）：chunk-SSD、chunk-RSSD/*
    - 机器型号（可多选）：S9、S4/*
    - pod信息（可选填参数）：25GE.D.R.001/不填默认default（意为不考虑pod信息）
    - 数量阈值（必填）：2台/*
    - 告警角色（单选）：udisk/*
    - 规则名称（必填项）：pod1备机/*

  - 规则名词解释： 

| 序号    | 名词    |方式    | 说明                              |
| ------ | ------  | ------| ------                           |
| 1      | 业务组   |单选    | 各业务组的简称，例：udisk/ark/ufs/*  |
| 2      | 机器类型 |单选    | 共两种，物理机/虚拟机                |
| 3      | 可用区   |单选    | CMDB可用区，例：北京二可用区B（cn-bj2-02）/*|
| 4      | 逻辑机房 |单选    | CMDB逻辑机房，例：HB06/*|
| 5      | 二级业务 |多选    | 业务组的二级业务，例：chunk-ssd、chunk-rssd/*|
| 6      | 机器型号 |多选    | CMDB机器型号，例：S4-U2-V5、S1-U2-V5/S1.U2.V6.32/*|
| 7      | pod信号 |选填参数 | CMDB机器交换机端口信息，例：HB06 pod1 交换机端口名称为，LAS.a.004_25GE.D.R.001_3F-M1-05-04_HD08，仅需要填写25GE.D.R.001，即可，不填pod信息将会是default参数，将不考虑机器pod信息
| 8      | 数量阈值 |必填    | 备用机器数量阈值|
| 9      | 告警角色 |单选    | 告警邮件发送角色，与告警模块关联，例：udisk_sre/resource/ark_sre/*|
| 10     | 规则名称 |必填    | 每个备用机器规则名称，添加新告警必填项|

  - 规则核心：
    - 1、二级业务与机器型号之间的多对多关系，最小可为单个逻辑机房的单个型号机器设置备用机器规则。
    - 2、pod信息选填：填——则可以满足udisk pod分组，不填——可满足其他业务不分pod的机器要求。
  


#### 备机设置规则示例如下：
  - 用户可灵活配置，以下仅仅展示两种常用配置规则，示例1、2区别在于SSD、RSSD同pod是否独立设置备机规则。
  - 示例1：以udisk北京二可用区E(cn-bj2-05)备机设置规则为示例(物理机，且SSD、RSSD`独立设置`备用机器规则)
    - SATA备用机器规则（注：线上共有2种机型S6-U2-V5、S2-U2-V4，分布在一个逻辑机房(HB06)且可以混合部署，不区分pod信息）
      - ![image](/uploads/6cb7e24233b4a1357f49fcdc0cf5eb28/image.png)

    - SSD备用机器规则（注：线上共有7种机型，这里只讲述三种机型配置S1.U2.V6.32、S4-U2-V5、S2-U1-V5，分布在两个逻辑机房（HB06、HB10)，且S4-U2-V5、S2-U1-V5可以混合部署，区分pod信息HB06 四个pod，HB10 1个pod）
      - ![image](/uploads/08cb5c82cce1cff265bc6387884ed489/image.png)

    - RSSD备用机器规则（注：线上共有4种机型，这里只讲述三种机型配置S1.U2.V6.32、S4-U2-V5、S2-U1-V5，分布在两个逻辑机房（HB06、HB10)，且S4-U2-V5、S2-U1-V5可以混合部署，区分pod信息HB06 四个pod，HB10 1个pod）
      - ![image](/uploads/10c7b3e9133bf81e6ed53a739165809d/image.png)

  - 示例2：以udisk北京二可用区E(cn-bj2-05)备机设置规则为示例(物理机，且SSD、RSSD`同pod设置`备用机器规则)
    - SSD、RSSD备用机器规则（注：线上共有7种机型，这里只讲述三种机型配置S1.U2.V6.32、S4-U2-V5、S2-U1-V5，分布在两个逻辑机房（HB06、HB10)，且S4-U2-V5、S2-U1-V5可以混合部署，区分pod信息HB06 四个pod，HB10 1个pod）
      - ![image](/uploads/4082bd963cffcab56ddfe0c28b9dc290/image.png)

### 2、备机展示——各业务备机按其设置规则分表展示功能
  - 描述：选择业务组、机器类型、可用区，将按该可用区的备机规则分类分表展示机器详情。

### 3、备机查找——备机匹配(查找)功能
  - 描述：以udisk为例，hb03 5012集群 宕机一台，IP为：178.78.78.78，需要一台备机来进行修复。
    - 使用描述：小明可在备机查找框内输入IP：178.78.78.78，点击搜索，将以列表的形式，展示可用备机详情。（机器详情：可用区/一级业务/二级业务/机器型号/逻辑机房/物理机房/状态（交付）/pod信息等其他信息）

### 4、备机监控——备机监控、告警功能
  - 描述：备机数量不足监控、自动告警（催机器），告警通知人设置。
    - 系统定时扫描各备机规则机器数量，比对备机规则阈值，小于阈值，将进行邮件告警。
    - 可设置多个告警角色，并为角色添加告警人信息。

  
# 二、数据来源
- 1、CMDB 
  - 通过Http接口，向CMDB请求机器的原始详情数据，供备机系统分析使用。
- 2、mikasa数据库
  - 自建数据库，用来维护备机配置规则，供备机系统分析使用。

# 三、详设信息
- 待完善

# 四、开发排期
- 一期：功能1、4
  - 1、备机设置——各业务备机规则设置功能
  - 4、备机监控——备机监控、告警功能

- 二期：功能2、3
  - 2、备机展示——各业务备机按设置规则展示功能
  - 3、备机查找——备机匹配(查找)功能


# 五、其他优化开发
- 1、备机配置、告警配置权限（即：谁可以来进行备机规则、告警规则设置权限）
  - 使用GW API管理服务来进行权限鉴定(暂定)
  
  ## 三、详细信息-数据字典
* 共三张表t_standby_rule、t_alarm_role、t_alarm_user

### 1、t_alarm_user表

| 序号    | 属性名        | 类型    | 备注                    |
| ------ | ------       | ------  | ------                 |
| 1      | user_id      | uint64  | 用户自增ID，代码层控制    |
| 2      | user_name    | string  | 用户名，例：boreas.zhao  |
| 3      | name         | string  | 用户昵称，例：赵鑫        |
| 4      | department   | string  | 用户所属部门，例：SRE研发部
| 5      | email        | string  | 用户邮箱，例：boreas.zhao@ucloud.cn|
| 6      | tel          | string  | 用户电话，1333333333    |
| 7      | create_name  | string  | 角色创建人              ｜
| 8      | create_time  | int64   | 角色创建时间             |
| 9      | status       | int     | 标记删除字段，0正常，1删除 |
| 10     | delete_name  | int     | 标记删除人               |
| 11     | delete_time  | int     | 标记删除时间             |

### 2、t_alarm_role表

| 序号    | 属性名        | 类型    | 备注                    |
| ------ | ------       | ------  | ------                 |
| 1      | role_id      | uint64  | 角色自增ID，代码层控制    |
| 2      | role_name    | string  | 角色名，例：udisk_sre、资源运营  |
| 3      | mumber       | []uint64| 角色成员id，例：1\2\3    |
| 3.1    | mumber_name  | []string| 角色成员名称，例彭晶鑫(sing.peng)、贾行陈(han.jia)、赵鑫(boreas.zhao)|
| 4      | create_name  | string  | 角色创建人              ｜
| 5      | create_time  | int64   | 角色创建时间             |
| 4      | update_name  | string  | 角色更新人              ｜
| 5      | update_time  | int64   | 角色最后一次更新时间      |
| 7      | status       | int     | 标记删除字段，0正常，1删除 |
| 8      | delete_name  | int     | 标记删除人               |
| 9      | delete_time  | int     | 标记删除时间             |

## 3、t_standby_rule表

| 序号    | 属性名        | 类型    | 备注                    |
| ------ | ------       | ------  | ------                 |
| 1      | rule_id      | uint64  | 规则自增ID，代码层控制    |
| 1.1    | rule_name    | string  | 监控规则名称             |
| 2      | usage        | string  | 一级业务简称，例：udisk、ufs、ark  |
| 3      | category     | string  | 机器类型，物理机/虚拟机    |
| 4      | zone         | string  | 可用区简称，cn-bj2-05    ｜
| 4.1    | zone_name    | string  | 可用区简称，北京二可用区E  ｜
| 5      | idc          | string  | 逻辑机房简称，HB10        |
| 5.1    | location     | string  | 物理机房简称，bj-fty      |
| 4      | sec_usage    | []string| 二级业务简称，chunk-rssd/chunk-ssd｜
| 5      | machine_type | []string| 机器类型简称，S1.U2.v6.32/S4-U2-V5     |
| 6      | pod_info     | string  | CMDB机器交换机端口信息，例：HB06 pod1 交换机端口名称为，LAS.a.004_25GE.D.R.001_3F-M1-05-04_HD08，仅需要填写25GE.D.R.001，即可，不填pod信息将会是default参数，将不考虑机器pod信息｜
| 7      | number       | int     | 机器真实数量             |
| 8      | threshold    | int     | 机器监控阈值             |
| 9      | role_id      | int     | 角色ID                  |
| 9.1    | role_name    | string  | 角色名称：    udisk      |
| 10     | remark       | string  | 备注：可以用以标记是哪些集群的备用机器|
| 11     | create_name  | string  | 创建人                  |
| 12     | create_time  | int     | 创建时间                 |
| 13     | updata_name  | string  | 最后一次修改人           |
| 14     | update_time  | int     | 最后一次修改时间          |
| 15     | status       | int     | 标记删除字段，0正常，1删除 |
| 16     | delete_name  | string  | 标记删除人               |
| 17     | delete_time  | int     | 标记删除时间             |

